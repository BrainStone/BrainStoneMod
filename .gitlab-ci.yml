variables:
  GIT_SUBMODULE_STRATEGY: recursive
  ORIG_ARTIFACTS: "$CI_PROJECT_DIR/**/build/libs/*.jar*"
  ARTIFACTS: "$CI_PROJECT_DIR/*.jar*"
  GRADLE_OPTS: >
    -Dorg.gradle.project.branchName="$CI_COMMIT_REF_NAME"
    -Dorg.gradle.project.secret="$secret"
    -Dorg.gradle.project.curseForgeApiKey="$curseForgeApiKey"

cache:
  key: "$CI_COMMIT_REF_NAME/$CI_COMMIT_SHA"
  untracked: true

before_script:
  - shopt -s globstar
  - shopt -s nullglob

stages:
- build
- test
- deploy
  
build:
  stage: build
  script:
  - ./gradlew --console=plain assemble
  - cp $ORIG_ARTIFACTS .
  when: on_success
  artifacts:
    paths:
    - $ARTIFACTS

checkTranslations:
  stage: test
  script:
  - ./gradlew --continue --console=plain checkTranslations
  - if test -n "$(find . -maxdepth 1 -name '*.lang.txt' -print -quit)"; then
  - tail -vn+1 *.lang.txt
  - exit 1
  - fi
  when: on_success
  allow_failure: true
    
deploy:
  stage: deploy
  script:
  - ./gradlew --console=plain uploadArchives curseforge updateDownloadServer
  when: on_success
  only:
  - tags